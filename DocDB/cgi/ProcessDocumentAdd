#! /usr/bin/perl
#
# Author Eric Vaandering (ewv@fnal.gov)
#
# 
#

use CGI;                                                                                      
use DBI;

require "ResponseElements.pm";
require "MySQLAccess.pm";
require "DocDBGlobals.pm";

$query = new CGI;  # Global for subroutines
$dbh   = DBI->connect('DBI:mysql:'.$db_name.':'.$db_host,$db_rwuser,$db_rwpass);

&GetAuthors;
&GetTopics;

%params = $query -> Vars;
$mode = $params{mode};

print $query->header;
print $query->start_html(-title=>"BTeV Document Reservation Results");

print "Mode is $mode<p>\n";

if ($mode ne "add" && $mode ne "reserve") {
  &EndPage("<p><h3>You accessed this page without 
            specifying a required parameter. 
            Don't mess with hidden fields or 
            try to access this page directly.</h3>\n"); 
}  

my $document_insert = $dbh->prepare("insert into Document (DocumentID,
                                      RequesterID, RequestDate, DocumentType) 
                                      values (0,?,NOW(),?)");
my $doc_rev_insert = $dbh->prepare("insert into DocumentRevision (DocRevID,
                                      DocumentID, SubmitterID, DocumentTitle,
                                      PublicationInfo, VersionNumber, Abstract, 
                                      Private) values (0,?,?,?,?,?,?,?)");
my $rev_author_insert = $dbh->prepare("insert into RevisionAuthor (RevAuthorID,
                                      DocRevID, AuthorID) 
                                      values (0,?,?)");
my $rev_topic_insert  = $dbh->prepare("insert into RevisionTopic  (RevTopicID,
                                      DocRevID, MinorTopicID) 
                                      values (0,?,?)");

@error_stack = ();

unless ($params{requestor}) {
  push @error_stack,"You must supply a requestor for this document.";
}
unless ($params{title}) {
  push @error_stack,"You must supply a title for this document.";
}
unless ($params{doctype}) {
  push @error_stack,"You must supply a document type for this document.";
}
if ($mode eq "add") {
  unless ($params{authors}) {
    push @error_stack,"You must supply at least one author for this document.";
  }
  unless ($params{topics}) {
    push @error_stack,"You must supply at least one topic for this document.";
  }
}

if (($#error_stack + 1)) {
  &EndPage(@error_stack);
}

# OK, we've validated the inputs are all there. Now add info to database

@authorIDs = split ("\0",$params{authors}); 
@topicIDs  = split ("\0",$params{topics});

$document_insert -> execute($params{requestor},$params{doctype});
my $documentID = $document_insert -> {insertid}; # Works with MySQL only

if      ($mode eq "reserve") {
  my $version   = 0;
} elsif ($mode eq "add") {
  my $version   = 1;
}

$doc_rev_insert -> execute($documentID,$params{requestor},$params{title},
                           $params{pubinfo},$version,$params{abstract},
                           $params{private});
my $docRevID = $doc_rev_insert -> {insertid}; # Works with MySQL only
                           
foreach $authorID (@authorIDs) {
  $rev_author_insert -> execute($docRevID,$authorID);
}
foreach $topicID (@topicIDs) {
  $rev_topic_insert -> execute($docRevID,$topicID);
}

# Figure out directory names and make directories

if ($mode eq "add") {
  $hun_dir = sprintf "%4.4d/",int($documentID/100);
  $sub_dir = sprintf "%6.6d/",$documentID;
  $ver_dir = sprintf "%3.3d/",$version;
  $new_dir = $file_root.$hun_dir.$sub_dir.$ver_dir;

  mkdir  $file_root.$hun_dir;
  mkdir  $file_root.$hun_dir.$sub_dir;
  mkdir  $file_root.$hun_dir.$sub_dir.$ver_dir;

# Copy file to directory

  $short_file   = $query ->  param("single_upload");
  $short_handle = $query -> upload("single_upload");

  open (OUTFILE,">$new_dir/$short_file");
  while ($bytes_read = read($short_handle,$buffer,1024)) {
    print OUTFILE $buffer
  }
  close OUTFILE;
}

# Output feedback to the user

print "Your Document ID is <b>BTeV-doc-$documentID</b><p> which was created with
the following information. Please make a note of the document number as you will
need it to update your document.\n"; 

&AuthorListByID(@authorIDs);
&TopicListByID(@topicIDs);

print $query->end_html;

