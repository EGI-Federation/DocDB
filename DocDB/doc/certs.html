<title>SSL and DocDB</title>

<body bgcolor="#FFFFFF" text="#000000" topmargin="6" leftmargin="6" marginheight="6" marginwidth="6">

<center><h1>SSL and DocDB</h1></center>

<p>
<ol>
<li> <font color=red>These notes assume that you are using 
     <a href=http://httpd.apache.org/docs-project/>Apache</a>.</font> <br>
     If you are using a different server, please refer to that documentation.
<li> The standard apache distributed by RedHat (and found in SL3) defines
     a default secure server via <b>/etc/httpd/conf.d/ssl.conf</b>.
     You may wish to remove (or rename) this file and merge its contents
     with <b>/etc/httpd/conf/httpd.conf</b>.
<li> Create a directory for trusted certificate authorities:
     <b>mkdir /full/path/to/TrustedCAs</b>
<li> Download public keys into this directory. <br>
     Fermilab <a href=http://computing.fnal.gov/security/pki/>public keys</a><br>
     You will need at least the self-signed FNAL KCA certificate and the
     FNAL Top Level CA signing policy.
<li> Modify httpd.conf:
    <ul>
    <li> Your httpd.conf needs to contain the following lines in the main body: <br>
	 <b>Listen your.ip.address:80</b><br>
	 <b>Listen your.ip.address:443</b><br>
	 <b>LoadModule ssl_module modules/mod_ssl.so</b><br>
	 <b>AddType application/x-x509-ca-cert .crt</b><br>
	 <b>AddType application/x-pkcs7-crl    .crl</b><br>
    <li> You will have at least two virtual hosts - one for port 80 and one for port 443.
    <li> Turn SSL off for port 80: <br>
	 <b>
	 &lt;VirtualHost *:80&gt;<br>
	    &nbsp;&nbsp;&nbsp;&nbsp; SSLEngine off<br>
	    &nbsp;&nbsp;&nbsp;&nbsp; ....<br>
	 &lt;/VirtualHost&gt;
	 </b>
    <li> Make sure you have a virtual host for port 443: <br>
	 <b>
	 &lt;VirtualHost websrv1.fnal.gov:443&gt;<br>
	 &nbsp;&nbsp;&nbsp;&nbsp; SSLEngine on<br>
	 &nbsp;&nbsp;&nbsp;&nbsp; ErrorLog logs/ssl_error_log<br>
	 &nbsp;&nbsp;&nbsp;&nbsp; TransferLog logs/ssl_access_log<br>
	 &nbsp;&nbsp;&nbsp;&nbsp; SSLCACertificatePath full/path/to/TrustedCAs<br>
	 &nbsp;&nbsp;&nbsp;&nbsp; SSLCertificateFile /full/path/to/certs/yourserver.cert.cert<br>
	 &nbsp;&nbsp;&nbsp;&nbsp; SSLCertificateKeyFile /full/path/to/certs/yourserver.cert.key<br>
	 &nbsp;&nbsp;&nbsp;&nbsp; SSLVerifyClient require<br>
	 &nbsp;&nbsp;&nbsp;&nbsp; SSLVerifyDepth  2<br>
	 &nbsp;&nbsp;&nbsp;&nbsp; SSLOptions +StdEnvVars<br>
	 &nbsp;&nbsp;&nbsp;&nbsp; SetEnvIf User-Agent ".*MSIE.*" \<br>
	 &nbsp;&nbsp;&nbsp;&nbsp;	  nokeepalive ssl-unclean-shutdown \<br>
	 &nbsp;&nbsp;&nbsp;&nbsp;	  downgrade-1.0 force-response-1.0<br>
	 &nbsp;&nbsp;&nbsp;&nbsp; ....<br>
	 &lt;/VirtualHost&gt;
	 </b>
    <li> Make sure to require SSL permissions for the appropriate directories<br>
	 <b>
	 &lt;Directory "/some/html/dir/secure"&gt;<br>
	 &nbsp;&nbsp;&nbsp;&nbsp; SSLRequireSSL<br>
	 &nbsp;&nbsp;&nbsp;&nbsp; ....<br>
	 &lt;/Directory &gt;<br>
	 </b>
    </ul>
<li> You will need signed certificates in <b>/full/path/to/certs/</b>
<li> Getting a self-signed certificate at Fermilab.
     <ul> 
     <li> Download <a href=http://www.fnal.gov/docs/products/apache/simple.cnf>simple.cnf</a> <br>
          <font color=red>You will need this to get a DOEGrid host certificate.</font>
     <li> <b>openssl req -config simple.cnf -new -out new.cert.csr</b>
     <pre>
     Generating a 1024 bit RSA private key
     ...++++++
     ............++++++
     writing new private key to 'privkey.pem'
     Enter PEM pass phrase: (pick something)
     Verifying - Enter PEM pass phrase:   (pick something)
     -----
     You are about to be asked to enter information that will be incorporated
     into your certificate request.
     What you are about to enter is what is called a Distinguished Name or a DN.
     There are quite a few fields but you can leave some blank
     For some fields there will be a default value,
     If you enter '.', the field will be left blank.
     -----
     Organizational Unit Name (eg, section) [Services]: (appropriate dept. name)
     First Domain Component [DOEGrids]:
     First Domain Component [org]:FNAL
     Common Name (eg, YOUR name) [foo.fnal.gov]:yourserver.fnal.gov

     Please enter the following 'extra' attributes
     to be sent with your certificate request
     A challenge password (do not use for DOEGrid) []:
     An optional company name []:Fermilab
     </pre>
     <li> <b>openssl rsa -in privkey.pem -out new.cert.key</b>
     <pre>
     Enter pass phrase for privkey.pem:
     writing RSA key
     </pre>
     <li> If you want to view the certificate request: 
          <b>openssl req -noout -text -in new.cert.csr</b>
     <li> If you want to view your key: 
          <b>openssl req -noout -text -in new.cert.key</b>
     <li> Self-signed certificate: 
         <b>openssl x509 -in new.cert.csr -out new.cert.cert -req -signkey new.cert.key -days 365</b>
     </ul> 
<li> See 
     <a href=http://www.fnal.gov/docs/products/apache/SSLNotes.html>Mark Mengel's instructions</a>
     to get a DOEGrid certificate.
</ol>

<p>
<!-- begin footer -->
<hr>
<h3><a href=DocDB-license.html>DocDB License</a></h3>
<i><font size="-1">
<script language="javascript">
<!-- Hide from browsers that do not understand Javascript
// print the URL and modification date of this page
var url = document.location;
document.write(url)  
var dt = document.lastModified;
document.write('<br> Last Modified:')  
document.write(dt)  
// end hiding --> 
</script> 
</font></i>
</body>
</html>
