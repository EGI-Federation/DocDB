FROM cern/cc7-base:latest

RUN yum upgrade -y && \
    yum clean all && \
    rm -rf /var/cache/yum

RUN yum install -y httpd mod_ssl \
                   sudo git \
                   perl perl-CPAN perl-CGI perl-DBI perl-DBD-MySQL perl-DateTime perl-File-MimeInfo \
                   perl-MailTools perl-XML-Twig perl-libxml-perl perl-DateTime-Format-ICal perl-libwww-perl \
                   perl-Data-ICal python-pip perl-Digest-SHA1 perl-XML-Simple \
                   sendmail sendmail-cf python3 pip3 \
                   && yum clean all \
                   && rm -rf /var/cache/yum



# Jobber is a lightweight cron replacement written in Go
RUN rpm -i https://github.com/dshearer/jobber/releases/download/v1.4.4/jobber-1.4.4-1.el8.x86_64.rpm
ADD dot-jobber.yaml /root/.jobber

# j2cli is used for templating config files which will be useful for passing environment variables
RUN python3 -m pip install --no-cache-dir --upgrade pip
RUN python3 -m pip install --no-cache-dir --upgrade setuptools
RUN python3 -m pip install --no-cache-dir j2cli

# This file was generated by running CPAN once in "manual" not "local::lib" mode
ADD MyConfig.pm /root/.cpan/CPAN/MyConfig.pm
RUN sudo cpan -i CGI::Untaint

# Get DocDB software and install it
RUN git clone https://github.com/ericvaandering/DocDB.git
RUN mkdir -p /var/www/cgi-bin/DocDB && cp DocDB/DocDB/cgi/* /var/www/cgi-bin/DocDB
RUN mkdir -p /var/www/html/DocDB/Static/ && cp -R /DocDB/DocDB/html/css/ /DocDB/DocDB/html/js/ /DocDB/DocDB/html/img/ /var/www/html/DocDB/Static/

ADD docker-entrypoint.sh /
ENTRYPOINT ["/docker-entrypoint.sh"]
